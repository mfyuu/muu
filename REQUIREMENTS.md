# runz - ミニマルタスクランナー 要件定義書

## 概要

runz は Rust 製のミニマルで高速なタスクランナー。TOML ファイルでタスクを定義し、プロジェクトローカルとグローバルの設定を共存でき、インタラクティブなセレクターによるタスク実行をサポートする。

## 設計方針

- ミニマル: 依存グラフ・並列実行・ビルドシステム機能は持たない
- 高速: Rust シングルバイナリ、即時起動
- 直感的: シンプルな TOML ベースの設定、あいまい検索対応のインタラクティブセレクター
- 実用的: 位置引数と名前付き引数の両方に対応

---

## タスク定義フォーマット

### ファイル: `runz.toml`（ローカル） / `~/.config/runz/config.toml`（グローバル）

```toml
[tasks.deploy]
description = "S3にデプロイ"
cmd = "aws s3 sync $dir s3://$bucket"
args = { dir = ".", bucket = "" }

[tasks.lint]
description = "リント実行"
cmd = "eslint src/"

[tasks.setup]
description = "環境構築"
cmd = """
brew install node
npm install
"""
```

### タスクプロパティ

| プロパティ | 型 | 必須 | 説明 |
|-----------|------|------|------|
| `cmd` | string | yes | 実行するコマンド。`"""`で複数行対応。 |
| `description` | string | no | `runz list` やセレクターで表示される説明文。 |
| `args` | インラインテーブル | no | 引数定義。キーの順序 = 位置引数の順序。 |

### 引数定義

引数はインラインテーブルで定義する。各キーバリューが1つの引数に対応する:

```toml
args = { dir = ".", bucket = "" }
```

- キー = 引数名（`cmd` 内で `$name` として参照、`--name=value` フラグとしても使用）
- 値 = デフォルト値
- 空文字（`""`） = 必須（デフォルトなし、未指定時はエラー）
- 空文字以外 = 任意（省略時はデフォルト値を使用）
- 定義順 = 位置引数の順序

---

## 引数の渡し方

引数の渡し方は2通り。混在は不可。

### 位置引数（定義順に対応）

```bash
$ runz deploy ./dist my-bucket
# → dir="./dist", bucket="my-bucket"
```

末尾の引数を省略するとデフォルト値が使われる（必須ならエラー）:

```bash
$ runz deploy ./dist
# → dir="./dist", bucket="" → エラー（bucket は必須）
```

### 名前付き引数（キーを明示）

```bash
$ runz deploy --bucket=my-bucket
# → dir="."（デフォルト）, bucket="my-bucket"
```

### ルール

- 1回の呼び出しで位置引数のみ、または名前付き引数のみ（混在不可）
- 位置引数は定義順に割り当てられる
- 未指定の引数はデフォルト値にフォールバック
- 必須引数（デフォルト = `""`）が未指定 → わかりやすいエラーメッセージを表示

---

## コマンド

### `runz <task> [args...]`

タスクを直接実行する。

```bash
$ runz deploy ./dist my-bucket
$ runz deploy --bucket=my-bucket
$ runz lint
```

- 必須引数が未指定 → エラー
- タスクが見つからない → エラー

### `runz`（タスク未指定）

インタラクティブセレクターを起動する。

- 全タスク（ローカル + グローバルをマージ）を説明文・ソースラベル付きで表示
- あいまい検索・フィルタ対応
- 選択して Enter → セレクターを終了し、シェルの入力に `runz <選択したタスク> `（末尾にスペース）を配置
- ユーザーはそのまま引数を入力して Enter で実行可能

### `runz -g` / `runz -l`

ソースでタスクをフィルタ:

| フラグ | 挙動 |
|--------|------|
| `-g` | グローバルタスクのみ表示 |
| `-l` | ローカルタスクのみ表示 |
| なし | 全て表示（マージ済み） |

### `runz list`

全タスクをフォーマットされた一覧で表示する。

```
deploy    - S3にデプロイ              [local]
lint      - リント実行                [local]
setup     - 環境構築                  [local]
git-prune - gitブランチ整理           [global]
```

- タスク名、説明文、ソース（`[local]` / `[global]`）を表示
- `runz` と同様に `-g` / `-l` フラグに対応

### `runz init`

カレントディレクトリに `runz.toml` のひな形を生成する。

- `runz.toml` が既に存在する場合 → エラー（上書きしない）
- サンプルタスク（例: `echo "hello"`）を含むファイルを生成

### `runz --version`

runz のバージョンを表示する。

---

## 設定の解決

### ファイル探索

- **ローカル**: カレントディレクトリから上方向に `runz.toml` を探索。最初に見つかったものを使用。
- **グローバル**: `~/.config/runz/config.toml`（固定パス）

### マージルール

- ローカルとグローバルのタスクは1つのリストにマージされる
- 同名のタスクがローカルとグローバルの両方にある場合 → **ローカル優先**（グローバル側は非表示、警告なし）
- ローカルとグローバルのいずれか1つ以上の設定ファイルが必要。どちらもない場合 → エラー

### 重複検知

- **同一スコープ内**（ローカル同士 or グローバル同士）: タスク名の重複 → **エラー**
- **スコープをまたぐ**（ローカル vs グローバル）: ローカルがグローバルを暗黙的に上書き

---

## 複数行コマンド

複数行コマンドは TOML の複数行文字列を使用する:

```toml
[tasks.setup]
cmd = """
brew install node
npm install
"""
```

- 各行は単一のシェル（zsh）で順次実行される
- いずれかの行が失敗（終了コード非ゼロ）した場合 → 即座に実行を停止（`set -e` 相当）

---

## エラーハンドリング

| 状況 | 挙動 |
|------|------|
| 必須引数の未指定 | エラー: `error: missing required argument '<名前>'` |
| タスクが見つからない | エラー: `error: task '<名前>' not found` |
| 設定ファイルが見つからない | エラー: `error: no runz.toml or global config found` |
| 同一スコープ内でタスク名重複 | エラー: `error: duplicate task '<名前>' in <パス>` |
| `runz init` で既存ファイルあり | エラー: `error: runz.toml already exists` |
| コマンド実行失敗 | 失敗したコマンドの終了コードで終了 |

---

## シェル連携

- 全コマンドは `zsh -c "<cmd>"` で実行される
- インタラクティブセレクターは選択時にシェルの入力バッファにテキストを配置する（実装方法はターミナルの対応状況に応じて決定）

---

## テスト

### 方針

- ユニットテストとインテグレーションテストの両方を充実させる
- 主要なロジックには必ずユニットテストを書く
- CLI の動作はインテグレーションテストで検証する

### ユニットテスト

各モジュールに `#[cfg(test)]` でテストを記述する。以下を重点的にカバーする:

- TOML 設定ファイルのパース（正常系・異常系）
- 引数の解決（位置引数・名前付き引数・デフォルト値・必須引数エラー）
- 設定のマージロジック（ローカル優先・重複検知）
- コマンド文字列への引数展開

### インテグレーションテスト

`tests/` ディレクトリに配置し、実際の CLI バイナリを実行して検証する:

- 各コマンド（`runz <task>`、`runz list`、`runz init`、`runz --version`）の正常動作
- エラーケース（タスク未発見、必須引数不足、設定ファイル不在など）の終了コードとエラーメッセージ
- ローカル / グローバル設定ファイルの探索とマージ
- 複数行コマンドの実行と途中失敗時の停止

### 推奨クレート

- `assert_cmd`: CLI バイナリの実行と出力検証
- `tempfile`: テスト用一時ディレクトリ・ファイルの作成
- `pretty_assertions`: テスト失敗時の差分表示改善

---

## スコープ外（v1）

- タスクエイリアス
- 依存グラフ / タスク間依存
- タスクの並列実行
- ウォッチモード
- 環境変数管理 / `.env` 読み込み

---

## 技術メモ

- 言語: Rust
- 設定フォーマット: TOML（`toml` クレート — インラインテーブルのキー順序を保持）
- CLI パーサー: `clap`
- インタラクティブセレクター: `skim` または類似のあいまい検索ライブラリ
- 配布形態: シングルバイナリ（ランタイム依存なし）
